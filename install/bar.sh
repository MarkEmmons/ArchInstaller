#!/bin/bash

BARS=( "                              "
"                              "
"                              "
"                              "
"|                             "
"|                             "
"|                             "
"||                            "
"||                            "
"||                            "
"|||                           "
"|||                           "
"|||                           "
"|||                           "
"||||                          "
"||||                          "
"||||                          "
"|||||                         "
"|||||                         "
"|||||                         "
"||||||                        "
"||||||                        "
"||||||                        "
"||||||                        "
"|||||||                       "
"|||||||                       "
"|||||||                       "
"||||||||                      "
"||||||||                      "
"||||||||                      "
"|||||||||                     "
"|||||||||                     "
"|||||||||                     "
"||||||||||                    "
"||||||||||                    "
"||||||||||                    "
"||||||||||                    "
"|||||||||||                   "
"|||||||||||                   "
"|||||||||||                   "
"||||||||||||                  "
"||||||||||||                  "
"||||||||||||                  "
"|||||||||||||                 "
"|||||||||||||                 "
"|||||||||||||                 "
"|||||||||||||                 "
"||||||||||||||                "
"||||||||||||||                "
"||||||||||||||                "
"|||||||||||||||               "
"|||||||||||||||               "
"|||||||||||||||               "
"||||||||||||||||              "
"||||||||||||||||              "
"||||||||||||||||              "
"||||||||||||||||              "
"|||||||||||||||||             "
"|||||||||||||||||             "
"|||||||||||||||||             "
"||||||||||||||||||            "
"||||||||||||||||||            "
"||||||||||||||||||            "
"|||||||||||||||||||           "
"|||||||||||||||||||           "
"|||||||||||||||||||           "
"||||||||||||||||||||          "
"||||||||||||||||||||          "
"||||||||||||||||||||          "
"||||||||||||||||||||          "
"|||||||||||||||||||||         "
"|||||||||||||||||||||         "
"|||||||||||||||||||||         "
"||||||||||||||||||||||        "
"||||||||||||||||||||||        "
"||||||||||||||||||||||        "
"|||||||||||||||||||||||       "
"|||||||||||||||||||||||       "
"|||||||||||||||||||||||       "
"|||||||||||||||||||||||       "
"||||||||||||||||||||||||      "
"||||||||||||||||||||||||      "
"||||||||||||||||||||||||      "
"|||||||||||||||||||||||||     "
"|||||||||||||||||||||||||     "
"|||||||||||||||||||||||||     "
"||||||||||||||||||||||||||    "
"||||||||||||||||||||||||||    "
"||||||||||||||||||||||||||    "
"||||||||||||||||||||||||||    "
"|||||||||||||||||||||||||||   "
"|||||||||||||||||||||||||||   "
"|||||||||||||||||||||||||||   "
"||||||||||||||||||||||||||||  "
"||||||||||||||||||||||||||||  "
"||||||||||||||||||||||||||||  "
"||||||||||||||||||||||||||||| "
"||||||||||||||||||||||||||||| "
"||||||||||||||||||||||||||||| "
"||||||||||||||||||||||||||||||"
"||||||||||||||||||||||||||||||" )

SPINNER=('/' '-' '\' '|')
COLS=$(tput cols)

percent(){
	echo "$1" > /tmp/bar.txt
}

status_bar(){

    COMPLETED=$(cat /tmp/bar.txt)
    FUN_NAME=
    i=0

    NUM_TABS=$((3 - (${#1} / 8)))
    case $NUM_TABS in
        1)
            FUN_NAME="$1\t"
            ;;
        2)
            FUN_NAME="$1\t\t"
            ;;
        3)
            FUN_NAME="\t\t\t" # Empty string
            ;;
        *)
            FUN_NAME="${1:0:24}" # Given string is too long
            ;;
    esac

    while [[ $COMPLETED -lt 100 ]]; do

        # Percent completed
        COMPLETED=$(cat /tmp/bar.txt)
		
		# Get bar from array
        BAR=${BARS[$(($COMPLETED))]}

        # Get time elapsed in MM:SS        
        CURRENT_TIME=$( date | sed -e 's|:| |g' | awk '{print ((($4*60)+$5)*60) + $6}' )
        TIME_DIFF=$(($CURRENT_TIME - $START_TIME))
        M=$(($TIME_DIFF / 60))
        S=$(($TIME_DIFF - ($M * 60)))        

        # Print out status bar
        { tput setaf 7 && \
            tput bold && \
            echo -ne "\r$FUN_NAME"
            printf "%02d:%02d " $M $S && \
            echo -ne "${SPINNER[(($i))]}${BAR} [${COMPLETED}%]" && \
            tput sgr0 \
            ;} >&3

        i=$((($i+1) % 3))
        sleep 0.15
    done     

    # Determine padding for right-aligned exit message
    CUR_POS=70
    EXIT_MSG_POS=$(($COLS - 9))

    NUM_SPACES=$(($EXIT_MSG_POS - $CUR_POS))
    
	# Create exit message
    SPACES=$(printf "%-${NUM_SPACES}s" " ")
    EXIT_MSG=$(printf "${SPACES// / }  Completed")
        
    # Print out completed status bar
    { tput setaf 7 && \
        tput bold && \
        tput sc && \
        echo -ne "\r$FUN_NAME"
        printf "%02d:%02d " $M $S && \
        echo -ne "${SPINNER[((3))]}${BAR} [${COMPLETED}%]" && \
        tput rc && \
        tput setaf 2 && \
        printf "$EXIT_MSG\n"
        tput sgr0 \
        ;} >&3

    rm -f /tmp/bar.txt
    echo
}
